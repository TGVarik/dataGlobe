/*! dataGlobe 2014-09-26 */
function Graph(a){this.options=a||{},this.nodeSet={},this.nodes=[],this.edges=[],this.layout}function Node(a){this.id=a,this.nodesTo=[],this.nodesFrom=[],this.position={},this.data={}}function Edge(a,b){this.source=a,this.target=b,this.data={}}Graph.prototype.addNode=function(a){return void 0!=this.nodeSet[a.id]||this.reached_limit()?!1:(this.nodeSet[a.id]=a,this.nodes.push(a),!0)},Graph.prototype.getNode=function(a){return this.nodeSet[a]},Graph.prototype.addEdge=function(a,b){if(a.addConnectedTo(b)===!0){var c=new Edge(a,b);return this.edges.push(c),!0}return!1},Graph.prototype.reached_limit=function(){return void 0!=this.options.limit?this.options.limit<=this.nodes.length:!1},Node.prototype.addConnectedTo=function(a){return this.connectedTo(a)===!1?(this.nodesTo.push(a),!0):!1},Node.prototype.connectedTo=function(a){for(var b=0;b<this.nodesTo.length;b++){var c=this.nodesTo[b];if(c.id==a.id)return!0}return!1},THREE.Label=function(a,b){function c(){var b=d.getContext("2d"),c="40pt";b.font=c+" Arial";var e=b.measureText(a).width;d.setAttribute("width",e),b.font=c+" Arial",b.textBaseline="top",b.fillText(a,0,0);var f=new THREE.CubeGeometry(e,200,0),g=new THREE.MeshBasicMaterial({map:new THREE.Texture(d),transparent:!0});g.map.needsUpdate=!0;var h=new THREE.Mesh(f,g);return h}var d=document.createElement("canvas");return c()},THREE.ObjectSelection=function(a){function b(a){g.x=a.clientX/window.innerWidth*2-1,g.y=2*-(a.clientY/window.innerHeight)+1}function c(){d.INTERSECTED&&"function"==typeof f&&f(d.INTERSECTED)}var a=a||{};this.domElement=a.domElement||document,this.projector=new THREE.Projector,this.INTERSECTED;var d=this,e=a.selected,f=a.clicked,g={x:0,y:0};this.domElement.addEventListener("mousemove",b,!1),this.domElement.addEventListener("click",c,!1),this.render=function(a,b){var c=new THREE.Vector3(g.x,g.y,.5);this.projector.unprojectVector(c,b);var d=new THREE.Raycaster(b.position,c.sub(b.position).normalize()),f=d.intersectObject(a,!0);f.length>0?this.INTERSECTED!=f[0].object&&(this.INTERSECTED&&this.INTERSECTED.material.color.setHex(this.INTERSECTED.currentHex),this.INTERSECTED=f[0].object,this.INTERSECTED.currentHex=this.INTERSECTED.material.color.getHex(),this.INTERSECTED.material.color.setHex(16711680),"function"==typeof e&&e(this.INTERSECTED)):(this.INTERSECTED&&this.INTERSECTED.material.color.setHex(this.INTERSECTED.currentHex),this.INTERSECTED=null,"function"==typeof e&&e(this.INTERSECTED))}};var Layout=Layout||{};Layout.ForceDirected=function(a,b){var b=b||{};this.layout=b.layout||"2d",this.attraction_multiplier=b.attraction||5,this.repulsion_multiplier=b.repulsion||.75,this.max_iterations=b.iterations||1e3,this.graph=a,this.width=b.width||200,this.height=b.height||200,this.finished=!1;var c,d,e,f,g,h=b.positionUpdated,i=1e-6,j=0,k=0,l=0;this.init=function(){this.finished=!1,k=this.width/10,f=this.graph.nodes.length,g=this.graph.edges.length,e=Math.sqrt(this.height*this.width/f),c=this.attraction_multiplier*e,d=this.repulsion_multiplier*e},this.generate=function(){if(!(j<this.max_iterations&&k>1e-6))return this.finished||console.log("Average time: "+l/j+" ms"),this.finished=!0,!1;for(var b=(new Date).getTime(),e=0;f>e;e++){var m=a.nodes[e];m.layout=m.layout||{},0==e&&(m.layout.offset_x=0,m.layout.offset_y=0,"3d"===this.layout&&(m.layout.offset_z=0)),m.layout.force=0,m.layout.tmp_pos_x=m.layout.tmp_pos_x||m.position.x,m.layout.tmp_pos_y=m.layout.tmp_pos_y||m.position.y,"3d"===this.layout&&(m.layout.tmp_pos_z=m.layout.tmp_pos_z||m.position.z);for(var n=e+1;f>n;n++){var o=a.nodes[n];if(e!=n){o.layout=o.layout||{},o.layout.tmp_pos_x=o.layout.tmp_pos_x||o.position.x,o.layout.tmp_pos_y=o.layout.tmp_pos_y||o.position.y,"3d"===this.layout&&(o.layout.tmp_pos_z=o.layout.tmp_pos_z||o.position.z);var p=m.layout.tmp_pos_x-o.layout.tmp_pos_x,q=m.layout.tmp_pos_y-o.layout.tmp_pos_y;if("3d"===this.layout)var r=m.layout.tmp_pos_z-o.layout.tmp_pos_z;var s=Math.max(i,Math.sqrt(p*p+q*q));if("3d"===this.layout)var t=Math.max(i,Math.sqrt(r*r+q*q));var u=d*d/s;if("3d"===this.layout)var v=d*d/t;m.layout.force+=u,o.layout.force+=u,m.layout.offset_x+=p/s*u,m.layout.offset_y+=q/s*u,0==e&&(o.layout.offset_x=0,o.layout.offset_y=0,"3d"===this.layout&&(o.layout.offset_z=0)),o.layout.offset_x-=p/s*u,o.layout.offset_y-=q/s*u,"3d"===this.layout&&(m.layout.offset_z+=r/t*v,o.layout.offset_z-=r/t*v)}}}for(var e=0;g>e;e++){var w=a.edges[e],p=w.source.layout.tmp_pos_x-w.target.layout.tmp_pos_x,q=w.source.layout.tmp_pos_y-w.target.layout.tmp_pos_y;if("3d"===this.layout)var r=w.source.layout.tmp_pos_z-w.target.layout.tmp_pos_z;var s=Math.max(i,Math.sqrt(p*p+q*q));if("3d"===this.layout)var t=Math.max(i,Math.sqrt(r*r+q*q));var u=s*s/c;if("3d"===this.layout)var v=t*t/c;w.source.layout.force-=u,w.target.layout.force+=u,w.source.layout.offset_x-=p/s*u,w.source.layout.offset_y-=q/s*u,"3d"===this.layout&&(w.source.layout.offset_z-=r/t*v),w.target.layout.offset_x+=p/s*u,w.target.layout.offset_y+=q/s*u,"3d"===this.layout&&(w.target.layout.offset_z+=r/t*v)}for(var e=0;f>e;e++){var x=a.nodes[e],s=Math.max(i,Math.sqrt(x.layout.offset_x*x.layout.offset_x+x.layout.offset_y*x.layout.offset_y));if("3d"===this.layout)var t=Math.max(i,Math.sqrt(x.layout.offset_z*x.layout.offset_z+x.layout.offset_y*x.layout.offset_y));x.layout.tmp_pos_x+=x.layout.offset_x/s*Math.min(s,k),x.layout.tmp_pos_y+=x.layout.offset_y/s*Math.min(s,k),"3d"===this.layout&&(x.layout.tmp_pos_z+=x.layout.offset_z/t*Math.min(t,k));var y=!0;x.position.x-=(x.position.x-x.layout.tmp_pos_x)/10,x.position.y-=(x.position.y-x.layout.tmp_pos_y)/10,"3d"===this.layout&&(x.position.z-=(x.position.z-x.layout.tmp_pos_z)/10),y&&"function"==typeof h&&h(x)}k*=1-j/this.max_iterations,j++;var z=(new Date).getTime();return l+=z-b,!0},this.stop_calculating=function(){j=this.max_iterations}};var Drawing=Drawing||{};Drawing.SphereGraph=function(a){function b(){j=new THREE.WebGLRenderer({alpha:!0}),j.setSize(window.innerWidth,window.innerHeight),g=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e5),g.position.z=2e4,h=new THREE.OrbitControls(g),h.addEventListener("change",f),i=new THREE.Scene;var a=new THREE.SpotLight(10066329);a.position.set(1e4,100,1e3);var b=new THREE.AmbientLight(16777215),c=new THREE.SphereGeometry(o,40,30),d=new THREE.MeshPhongMaterial;d.map=THREE.ImageUtils.loadTexture("./img/world.jpg"),d.normalMap=THREE.ImageUtils.loadTexture("./img/earth_normal.jpg"),d.bumpScale=.05,d.specularMap=THREE.ImageUtils.loadTexture("./img/earth_specular.jpg"),d.specular=new THREE.Color(4473924);var e=new THREE.CubeGeometry(5e4,5e4,5e4),m=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture("./img/stars.jpg"),side:THREE.BackSide}),n=new THREE.Mesh(e,m);i.add(n),globe=new THREE.Mesh(c,d),globe.rotation.y=Math.PI,i.add(globe),i.add(a),i.add(b),k=new THREE.SphereGeometry(50,25,0),t.selection&&(l=new THREE.ObjectSelection({domElement:j.domElement,selected:function(a){null!=a?info_text.select="Object "+a.id:delete info_text.select}})),document.body.appendChild(j.domElement)}function c(a){var b=(90-a.position.x)*Math.PI/180,c=(180-a.position.y)*Math.PI/180;a.position.x=o*Math.sin(b)*Math.cos(c),a.position.y=o*Math.cos(b),a.position.z=o*Math.sin(b)*Math.sin(c);var d=new THREE.Geometry,e=new THREE.LineBasicMaterial({color:"white",linewidth:1});d.vertices.push(new THREE.Vector3(0*a.position.x,0*a.position.y,0*a.position.z)),d.vertices.push(new THREE.Vector3(1.05*a.position.x,1.05*a.position.y,1.05*a.position.z));var f=new THREE.Line(d,e);f.id=a.id,a.data.draw_object=f,a.layout={},a.layout.max_X=90,a.layout.min_X=-90,a.layout.max_Y=180,a.layout.min_Y=-180,a.data.draw_object.lookAt(i.position),i.add(a.data.draw_object)}function d(a,b,c,d){d=d||!1;var e=(u(a.position,b.position),2);material=new THREE.LineBasicMaterial({color:13421772,opacity:.5,linewidth:1});var f=a.position,g=b.position,h=(f.x+g.x)/2,j=(f.y+g.y)/2,k=(f.z+g.z)/2,l=(Math.abs(f.x-g.x),Math.abs(f.y-g.y),[h*e,j*e,k*e]),m=new THREE.QuadraticBezierCurve3(new THREE.Vector3(f.x,f.y,f.z),new THREE.Vector3(l[0],l[1],l[2]),new THREE.Vector3(g.x,g.y,g.z)),n=new THREE.CurvePath;n.add(m);var o=new THREE.LineBasicMaterial({color:c,linewidth:2,transparent:!0});curvedLine=new THREE.Line(n.createPointsGeometry(100),o),curvedLine.lookAt(i.position),d&&(curvedLine.material.transparent=!0,createjs.Tween.get(curvedLine.material).wait(4e3).to({opacity:0},5e3),console.log(curvedLine)),i.add(curvedLine)}function e(){requestAnimationFrame(e),h.update(),f()}function f(){m.layout&&(m.layout.finished||m.layout.generate());for(var a=0;a<n.length;a++)n[a].verticesNeedUpdate=!0;for(var a=0;a<m.nodes.length;a++);t.selection&&l.render(i,g),j.render(i,g)}{var a=a||{};({earth:{uniforms:{texture:{type:"t",value:null}},vertexShader:["varying vec3 vNormal;","varying vec2 vUv;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","vUv = uv;","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","varying vec3 vNormal;","varying vec2 vUv;","void main() {","vec3 diffuse = texture2D( texture, vUv ).xyz;","float intensity = 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );","vec3 atmosphere = vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );","gl_FragColor = vec4( diffuse + atmosphere, 1.0 );","}"].join("\n")},atmosphere:{uniforms:{},vertexShader:["varying vec3 vNormal;","void main() {","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec3 vNormal;","void main() {","float intensity = pow( 0.8 - dot( vNormal, vec3( 0, 0, 1.0 ) ), 12.0 );","gl_FragColor = vec4( 1.0, 1.0, 1.0, 1.0 ) * intensity;","}"].join("\n")}})}this.layout=a.layout||"2d",this.show_stats=a.showStats||!1,this.show_info=a.showInfo||!0,this.selection=a.selection||!1,this.limit=a.limit||10;var g,h,i,j,k,l,m=new Graph,n=[],o=4900,p=1e4,q=1e4,r=1e4,s=1e4,t=this;b(),e(),this.nodes=[],this.userNode,this.previousNode,this.addEdge=function(a,b){console.log(a),console.log(b);var c=m.getNode(a),e=m.getNode(b);m.addEdge(c,e)&&d(c,e,"red")},this.goToNode=function(a){var b=m.getNode(a),c=2.2*b.position.x,e=2.2*b.position.y,f=2.2*b.position.z;createjs.Tween.get(g.position).to({x:c,y:e,z:f},600),g.lookAt(i.position),this.previousNode&&m.addEdge(b,this.previousNode)&&d(b,this.previousNode,"red",!0),this.previousNode=b},this.getCurrent=function(){return this.previousNode},this.getNode=function(a){return m.getNode(a)},this.createGraph=function(a){if(null!==a.longitude&&null!==a.latitude){var b=new Node(a.fbId);b.position.x=a.latitude,b.position.y=a.longitude,b.data.name=a.name,m.addNode(b),c(b),this.nodes.push(b)}},this.createLayout=function(){var a={};a.width=2e3,a.height=2e3,a.iterations=1e5,a.layout="3d",a.positionUpdated=function(a){p=Math.max(p,a.position.x),q=Math.min(q,a.position.x),r=Math.max(r,a.position.y),s=Math.min(s,a.position.y),a.data.draw_object.position.x=Math.random()*p,a.data.draw_object.position.y=Math.random()*r,a.data.draw_object.position.z=Math.random()*p},m.layout=new Layout.ForceDirected(m,a),m.layout.init(),m.layout.generate()};var u=function(a,b){var c=a.x,d=a.y,e=b.x,f=b.y,g=4900,h=c.toRadians(),i=e.toRadians(),j=(e-c).toRadians(),k=(f-d).toRadians(),a=Math.sin(j/2)*Math.sin(j/2)+Math.cos(h)*Math.cos(i)*Math.sin(k/2)*Math.sin(k/2),l=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),m=g*l;return Math.round(m)};Number.prototype.toRadians=function(){return this*Math.PI/180},this.addUser=function(a,b){b=b||!1;var e=new Node(a.fbId);if(e.position.x=a.latitude,e.position.y=a.longitude,m.addNode(e),c(e),this.userNode=e,b)for(var f,g=0;g<m.nodes.length;g++)f=m.nodes[g],m.addEdge(this.userNode,f)&&d(this.userNode,f,"blue")}},$(document).ready(function(){$.get("/api/get-friends").then(function(a){var b=JSON.parse(a);b=b.data,setInterval(function(){b.length&&window.drawing.createGraph(b.pop())},0)}),$(".mutual").on("click",function(){$.get("/api/get-user").then(function(a){friendList=JSON.parse(a).friends;var b=function(a){var c=a.pop(),d={id:c};return $.post("/api/get-mutual",d).then(function(a){console.log("response: ",a);var b=JSON.parse(a),d=function(a){var b=a.pop();return window.drawing.addEdge(c,b),a.length?d(a):void 0};b.length&&d(b)}),a.length?b(a):void 0};b(friendList)})}),$(".connect").on("click",function(){$.get("/api/get-user").then(function(a){var b=JSON.parse(a);window.drawing.addUser(b,!0)})}),$(".fly").on("click",function(){$.get("/api/get-user").then(function(a){var b,d,e=JSON.parse(a).friends,f=0;setInterval(function(){for(f===e.length&&(f=0),b=e[f],d=window.drawing.getNode(b);!d;)f+=1,f===e.length&&(f=0),b=e[f],d=window.drawing.getNode(b);window.drawing.goToNode(b),FBData.get("newsFeed",b,function(a){a=JSON.parse(a),console.log(a),c(a)}),f+=1},4e3)})}),$(".newsFeed").on("click",function(){FBData.get("newsFeed","me",function(a){a=JSON.parse(a),console.log(a)})});var a=[],b=$('<div class="panel panel-default info-box"><div class="panel-heading info-header"></div><div class="panel-body info-data"></div></div>'),c=function(c){var d=b.clone(),e=d.find(".info-data"),f=d.find(".info-header");if(c.posts)for(var g=c.posts.data,h=Math.min(g.length,2),i=0;h>i;i++){var j=g[i];f.text(j.from.name),j.message&&(e.append("<p>"+j.message+"</p>"),e.append("<p>"+j.created_time+"</p>")),j.picture&&(e.append('<img class="info-img" src="'+j.picture+'"></img>'),e.append("<p>"+j.created_time+"</p>")),j.story&&(e.append("<p>"+j.story+"</p>"),j.link&&e.append('<p><a href="'+j.link+'">Take a Look</a><p>'))}else{var k=window.drawing.getCurrent().data.name;f.text(k),e.append("<p>No new updates.</p>")}$(".panel-wrapper").prepend(d),a.push(d),a.length>2&&(a[0].fadeOut("slow"),a.shift())}}),appConfig={fbId:"288494137936913"};var queryStringData={friendsQuery:{queryString:["SELECT uid, name, current_location.latitude, current_location.longitude, pic_square ","FROM user ","WHERE uid in (","SELECT uid2 FROM friend ","WHERE uid1 = me())"],url:"/api/save-friends",endpoint:"/fql"},timelineQuery:{queryString:[],url:"/api/save-timeline"},checkinsQuery:{queryString:["checkins{place,id,from,created_time,message,tags}"],type:"checkins",url:"/api/save-checkins",endpoint:"/me"},mutualFriends:{queryString:["SELECT uid1 FROM friend WHERE uid2=[targetID] AND uid1 IN (SELECT uid2 FROM friend WHERE uid1=me())"],url:"/api/save-mutual",endpoint:"/me"},newsFeed:{queryString:["posts{id,type,from,to,with_tags,created_time,message,story,link,name,tags,picture}"],endpoint:!1}},filter=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b},FBData=function(){function a(a,c,d){var f,g=e[a];f=g.endpoint?g.endpoint:"/"+c;var h={};"/fql"===f?h.q=g.queryString.join(""):h.fields=g.queryString.join(""),console.log("my query:",f,h),FB.api(f,h,function(a){var c,e;if(a){if("checkins"===g.type&&b(a),e=e||a,c=JSON.stringify(e),!g.url)return d(c);$.post(g.url,{response:c}).then(function(a){console.log("ajax success:",g.url,a)})}})}function b(a){if(a.next){var c=a.next,e=d(a);console.table(e),setTimeout(function(){$.get(c,function(a){console.table("paginated response:",a),b(a)})})}}function c(){$.get("/api/get-friends").then(function(a){console.log(a),a=JSON.parse(a);var b=a.data;$(".friends").text(b.length.toString()),$(".helper").toggle(),$(".title").toggle();var c=0,d=function(a){var b=a.pop(),e=b.fbId;FB.api("/me/mutualfriends/"+e,function(b){var f=filter(b.data),g={userB:e,mutuals:f};$.post("/api/save-mutual",g).then(function(){return c++,$(".done").text(""+c),a.length?d(a):void 0})})};d(b)})}function d(a){var b=[];return console.log("fb response",a),arrayOfCheckins=a.checkins?a.checkins.data:[],arrayOfCheckins.forEach(function(a,b){if(a){var c={fbId:a.id,checkin_date:a.data[b].created_time,place:{fbId:a.place.id,name:a.place.name,photo:null}||null,latitude:a.place.latitude,longitude:a.place.longitude,from:{name:a.from.name,fbId:a.from.id}||null,message:a.message||null,clique:a.tags.data||[]};results.push(c)}}),b}var e=queryStringData;return{get:a,getMutual:c}}();!function(a){function b(a){"connected"===a.status?d():document.getElementById("status").innerHTML="not_authorized"===a.status?"Please log into this app.":"Please log into Facebook."}function c(){FB.getLoginStatus(function(a){b(a)})}function d(){console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(a){console.log("Successful login for: "+a.name),document.getElementById("status").innerHTML="Thanks for logging in, "+a.name+"!",console.log("isloggedIn response:",a),FB.api("/fql",{q:"SELECT current_location.latitude, current_location.longitude, first_name, last_name, uid, pic_square FROM user WHERE uid = me()"},function(a){console.log("save user: ",a),$.post("/api/save-user",{user:a.data})})})}a.fbAsyncInit=function(){$.get("/fbconfig").then(function(a){console.log(a),console.log(typeof a),FB.init({appId:a||appConfig.fbId,cookie:!0,xfbml:!0,version:"v1.0"}),setTimeout(function(){c()},3e3)})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk")}(window),$(function(){$("button.query").on("click",function(a){a.preventDefault();var b=a.currentTarget.id;"mutualFriends"===b?FBData.getMutual():FBData.get(b)})});