/*! dataGlobe 2014-09-26 */
var queryStringData={friendsQuery:{queryString:["SELECT uid, name, current_location.latitude, current_location.longitude, pic_square ","FROM user ","WHERE uid in (","SELECT uid2 FROM friend ","WHERE uid1 = me())"],url:"/api/save-friends",endpoint:"/fql"},timelineQuery:{queryString:[],url:"/api/save-timeline"},checkinsQuery:{queryString:["checkins{place,id,from,created_time,message,tags}"],type:"checkins",url:"/api/save-checkins",endpoint:"/me"},mutualFriends:{queryString:["SELECT uid1 FROM friend WHERE uid2=[targetID] AND uid1 IN (SELECT uid2 FROM friend WHERE uid1=me())"],url:"/api/save-mutual",endpoint:"/me"},newsFeed:{queryString:["posts{id,type,from,to,with_tags,created_time,message,story,link,name,tags,picture}"],endpoint:!1}},filter=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b},FBData=function(){function a(a,c,d){var e,g=f[a];e=g.endpoint?g.endpoint:"/"+c;var h={};"/fql"===e?h.q=g.queryString.join(""):h.fields=g.queryString.join(""),console.log("my query:",e,h),FB.api(e,h,function(a){var c,e;if(a){if("checkins"===g.type&&b(a),e=e||a,c=JSON.stringify(e),!g.url)return d(c);$.post(g.url,{response:c}).then(function(a){console.log("ajax success:",g.url,a)})}})}function b(a){if(a.next){var c=a.next,d=e(a);console.table(d),setTimeout(function(){$.get(c,function(a){console.table("paginated response:",a),b(a)})})}}function c(){$.get("/api/get-friends").then(function(a){console.log(a),a=JSON.parse(a);var b=a.data;$(".friends").text(b.length.toString()),$(".helper").toggle(),$(".title").toggle();var c=0,d=function(a){var b=a.pop(),e=b.fbId;FB.api("/me/mutualfriends/"+e,function(b){var f=filter(b.data),g={userB:e,mutuals:f};$.post("/api/save-mutual",g).then(function(){return c++,$(".done").text(""+c),a.length?d(a):void 0})})};d(b)})}function d(a,b){FB.api("/"+a+"/likes",function(a){b(a)})}function e(a){var b=[];return console.log("fb response",a),arrayOfCheckins=a.checkins?a.checkins.data:[],arrayOfCheckins.forEach(function(a,b){if(a){var c={fbId:a.id,checkin_date:a.data[b].created_time,place:{fbId:a.place.id,name:a.place.name,photo:null}||null,latitude:a.place.latitude,longitude:a.place.longitude,from:{name:a.from.name,fbId:a.from.id}||null,message:a.message||null,clique:a.tags.data||[]};results.push(c)}}),b}var f=queryStringData;return{get:a,getMutual:c,getPostLikes:d}}();!function(a){function b(a){"connected"===a.status?d():document.getElementById("status").innerHTML="not_authorized"===a.status?"Please log into this app.":"Please log into Facebook."}function c(){FB.getLoginStatus(function(a){b(a)})}function d(){console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(a){console.log("Successful login for: "+a.name),document.getElementById("status").innerHTML="Thanks for logging in, "+a.name+"!",console.log("isloggedIn response:",a),FB.api("/fql",{q:"SELECT current_location.latitude, current_location.longitude, first_name, last_name, uid, pic_square FROM user WHERE uid = me()"},function(a){console.log("save user: ",a),$.post("/api/save-user",{user:a.data})})})}a.fbAsyncInit=function(){$.get("/fbconfig").then(function(a){console.log(a),console.log(typeof a),FB.init({appId:a||appConfig.fbId,cookie:!0,xfbml:!0,version:"v1.0"}),setTimeout(function(){c()})})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk")}(window),$(function(){$("button.query").on("click",function(a){a.preventDefault();var b=a.currentTarget.id;"mutualFriends"===b?FBData.getMutual():FBData.get(b)})});